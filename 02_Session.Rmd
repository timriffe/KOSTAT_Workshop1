---
title: "Session 2 notes"
author: "Tim Riffe"
date: "2025-06-24"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Life tables

For today's practice, we will read in the HMD data
```{r}
library(tidyverse)
hmd <- read_csv("https://github.com/timriffe/KOSTAT_Workshop1/raw/refs/heads/master/Data/hmd.csv.gz")

# we have 9352 lifetables
hmd |> 
  select(country, sex, year) |> 
  distinct() |> 
  nrow()

hmd |> 
  pull(sex) |> 
  unique()
```

# step 0 visualize it

```{r}
hmd |> 
  filter(year >= 1950,
         !country %in% c("Iceland","Luxembourg")) |> 
  mutate(mx = if_else(mx == 0, NA, mx)) |> 
  ggplot(mapping = aes(x = age, y = mx, group = year))+
  geom_line(alpha = .03) +
  scale_y_log10() +
  facet_wrap(~sex) 
```

Looks at one:

```{r}
hmd$country |> unique()
hmd |> 
  filter(country == "Sweden",
         year == 2015) |> 
  ggplot(mapping = aes(x = age, y =mx, color = sex)) +
  geom_line() +
  scale_y_log10()
```


# step 1: convert rates to probabilties

For single-age data, the formula to convert rates $m_x$ to probabilities $q_x$ is:

$$ q_x = \frac{m_x}{(1 + (1-a_x) \cdot m_x)}$$
 The formula still works for wider age groups ($n$ years wide) with a small modification:
 
 $$ {}_nq_x = \frac{n \cdot {}_nm_x}{1 + (n- {}_na_x)\cdot{}_nm_x}$$
Note: $n$ on the left subscript is to indicate that the variable covers an $n$-year wide interval starting at age $x$.

Select a subset-- what countries are available to pick from?
```{r}
hmd |> 
  pull(country) |> 
  unique()
```

now calculate qx:
```{r}
es <- 
  hmd |> 
  filter(country == "Spain",
         sex == "f",
         year == 2019) 
es |> 
  mutate(qx = mx / (1 + (1 - ax) * mx),
         qx = if_else(qx > 1, 1, qx), # optional
         qx = if_else(age == max(age), 1, qx)) # convention
```

Now let's put that in a function:

```{r}
mx_to_qx <- function(mx, ax){
  qx              <- mx / (1 + (1 - ax) * mx)
  # make sure it obeys the rules!
  qx[qx > 1]      <- 1
  # no one gets out!
  qx[length(qx)]  <- 1
  return(qx)
}
es <- 
es |> 
  mutate(qx = mx_to_qx(mx, ax)) 
```

# now calculate survivorship

survival probabilities are the complement of death probabilities...
$$ p_x  = 1 - q_x $$
These are the probabilities can chain together into overall survivorship:
$$ \ell_x = \prod _{0}^{x-1}p_x$$

```{r}
qx_to_lx <- function(qx, radix = 1e5){
  n <- length(qx)
  qx <- c(0,qx[-n])
  lx <- radix * cumprod(1-qx)
  return(lx)
}
```
Now let's try it out:

```{r}
es |> 
  mutate(qx = mx_to_qx(mx, ax),
         lx = qx_to_lx(qx),
         dx = qx * lx) |> 
  ggplot(aes(x = age, y = dx)) +
  geom_line()
```

# Exercise: Approximate lifetable exposure

$$ L_x = \ell_x - (d_x \cdot(1 - a_x))$$

anatomy of a function
```{r, eval = FALSE}
fun_name <- function(args, more_args){
  # do stuff with args
  return(result)
}
```

my take:
```{r}
calc_Lx <- function(lx,dx,ax){
  n     <- length(lx)
  Lx    <- lx - (dx * (1 - ax))
  Lx[n] <- lx[n] * ax[n]
  return(Lx)
}
```

apply it:

```{r}

es |> 
  mutate(qx = mx_to_qx(mx = mx, ax = ax),
         lx = qx_to_lx(qx, radix = 1),
         dx = lx * qx,
         Lx = calc_Lx(lx = lx, dx = dx, ax = ax))
```

# Calculate remaining life expectancy

```{r}
calc_ex <- function(Lx, lx){
  # this one is cumbersome:
  # Tx <- sum(Lx) - c(0,cumsum(Lx[-111]))  
  # this one makes your head spin:
  Tx <- Lx |> rev() |> cumsum() |> rev()
  ex <- Tx / lx # condition it! (scale it up)
  return(ex)
}
```

# apply
```{r}

```




